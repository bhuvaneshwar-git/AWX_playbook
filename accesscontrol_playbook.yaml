---
- name: Verify SSH Access Control compliance across hosts
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    export_dir: "/home/ansibleadmin/Documents/linux_hardening"
    collector_host: 192.168.2.129
    sshd_config: "/etc/ssh/sshd_config"

  tasks:

    - name: Ensure export directory exists on collector
      ansible.builtin.file:
        path: "{{ export_dir }}"
        state: directory
        mode: '0755'
      delegate_to: "{{ collector_host }}"
      run_once: true

    # ------------------------------------------------------------------
    # REQUIRED (You missed these)
    # ------------------------------------------------------------------

    - name: Check sshd_config file permissions
      ansible.builtin.stat:
        path: "{{ sshd_config }}"
      register: sshd_config_perm

    - name: Check SSH private key permissions
      shell: "ls -l /etc/ssh/*_key 2>/dev/null"
      register: ssh_key_perm
      failed_when: false
      changed_when: false

    # ------------------------------------------------------------------
    # READ CONFIG
    # ------------------------------------------------------------------

    - name: Read sshd_config
      ansible.builtin.slurp:
        src: "{{ sshd_config }}"
      register: sshd_raw

    - name: Convert sshd_config content
      set_fact:
        sshd_text: "{{ sshd_raw.content | b64decode }}"

    # ------------------------------------------------------------------
    # BUILD REPORT
    # ------------------------------------------------------------------

    - name: Build ordered SSH Access Control compliance report
      set_fact:
        ssh_report: >-
          {{
            {
              "inventory_id": ansible_hostname,
              "ip_address": inventory_hostname
            }
            |
            combine({
              "ensure_sshd_config_permissions": {
                "status": ('yes' if sshd_config_perm.stat.mode in ['0600','0640'] else 'no'),
                "remediation": ('Run: chmod 600 /etc/ssh/sshd_config'
                                if sshd_config_perm.stat.mode not in ['0600','0640']
                                else 'No action needed')
              },
              "ensure_private_keys_permissions": {
                "status": ('yes' if (ssh_key_perm.stdout | regex_search("600")) else 'no'),
                "remediation": ('Set permissions using: chmod 600 /etc/ssh/*_key'
                                if not (ssh_key_perm.stdout | regex_search("600"))
                                else 'No action needed')
              },
              "ensure_sshd_banner": {
                "status": ('yes' if sshd_text | regex_search("^Banner") else 'no'),
                "remediation": ('Add Banner /etc/issue.net in sshd_config.'
                                if not (sshd_text | regex_search("^Banner"))
                                else 'No action needed')
              },
              "ensure_sshd_ciphers": {
                "status": ('yes' if sshd_text | regex_search("^Ciphers") else 'no'),
                "remediation": ('Add strong ciphers to sshd_config.'
                                if not (sshd_text | regex_search("^Ciphers"))
                                else 'No action needed')
              },
              "ensure_sshd_kexalgorithms": {
                "status": ('yes' if sshd_text | regex_search("^KexAlgorithms") else 'no'),
                "remediation": ('Add secure KexAlgorithms.'
                                if not (sshd_text | regex_search("^KexAlgorithms"))
                                else 'No action needed')
              },
              "ensure_sshd_macs": {
                "status": ('yes' if sshd_text | regex_search("^MACs") else 'no'),
                "remediation": ('Add secure MACs.'
                                if not (sshd_text | regex_search("^MACs"))
                                else 'No action needed')
              },
              "ensure_sshd_access_configured": {
                "status": ('yes' if sshd_text | regex_search("AllowUsers|DenyUsers|AllowGroups|DenyGroups") else 'no'),
                "remediation": ('Add AllowUsers/DenyUsers in sshd_config.'
                                if not (sshd_text | regex_search("AllowUsers|DenyUsers|AllowGroups|DenyGroups"))
                                else 'No action needed')
              },
              "ensure_sshd_clientaliveinterval": {
                "status": ('yes' if sshd_text | regex_search("ClientAliveInterval") else 'no'),
                "remediation": ('Add ClientAliveInterval 300'
                                if not (sshd_text | regex_search("ClientAliveInterval"))
                                else 'No action needed')
              },
              "ensure_sshd_clientalivecountmax": {
                "status": ('yes' if sshd_text | regex_search("ClientAliveCountMax") else 'no'),
                "remediation": ('Add ClientAliveCountMax 3'
                                if not (sshd_text | regex_search("ClientAliveCountMax"))
                                else 'No action needed')
              },
              "ensure_sshd_disableforwarding": {
                "status": ('yes' if sshd_text | regex_search("DisableForwarding yes") else 'no'),
                "remediation": ('Add DisableForwarding yes'
                                if not (sshd_text | regex_search("DisableForwarding yes"))
                                else 'No action needed')
              },
              "ensure_sshd_gssapi_auth_disabled": {
                "status": ('yes' if sshd_text | regex_search("GSSAPIAuthentication no") else 'no'),
                "remediation": ('Add GSSAPIAuthentication no'
                                if not (sshd_text | regex_search("GSSAPIAuthentication no"))
                                else 'No action needed')
              },
              "ensure_sshd_hostbased_auth_disabled": {
                "status": ('yes' if sshd_text | regex_search("HostbasedAuthentication no") else 'no'),
                "remediation": ('Add HostbasedAuthentication no'
                                if not (sshd_text | regex_search("HostbasedAuthentication no"))
                                else 'No action needed')
              },
              "ensure_sshd_ignore_rhosts": {
                "status": ('yes' if sshd_text | regex_search("IgnoreRhosts yes") else 'no'),
                "remediation": ('Add IgnoreRhosts yes'
                                if not (sshd_text | regex_search("IgnoreRhosts yes"))
                                else 'No action needed')
              },
              "ensure_sshd_login_grace_time": {
                "status": ('yes' if sshd_text | regex_search("LoginGraceTime") else 'no'),
                "remediation": ('Add LoginGraceTime 60'
                                if not (sshd_text | regex_search("LoginGraceTime"))
                                else 'No action needed')
              },
              "ensure_sshd_loglevel": {
                "status": ('yes' if sshd_text | regex_search("^LogLevel") else 'no'),
                "remediation": ('Add LogLevel VERBOSE'
                                if not (sshd_text | regex_search("^LogLevel"))
                                else 'No action needed')
              },
              "ensure_sshd_maxauthtries": {
                "status": ('yes' if sshd_text | regex_search("MaxAuthTries") else 'no'),
                "remediation": ('Add MaxAuthTries 3'
                                if not (sshd_text | regex_search("MaxAuthTries"))
                                else 'No action needed')
              },
              "ensure_sshd_maxsessions": {
                "status": ('yes' if sshd_text | regex_search("MaxSessions") else 'no'),
                "remediation": ('Add MaxSessions 10'
                                if not (sshd_text | regex_search("MaxSessions"))
                                else 'No action needed')
              },
              "ensure_sshd_maxstartups": {
                "status": ('yes' if sshd_text | regex_search("MaxStartups") else 'no'),
                "remediation": ('Add MaxStartups 10:30:100'
                                if not (sshd_text | regex_search("MaxStartups"))
                                else 'No action needed')
              },
              "ensure_sshd_empty_passwords_disabled": {
                "status": ('yes' if sshd_text | regex_search("PermitEmptyPasswords no") else 'no'),
                "remediation": ('Add PermitEmptyPasswords no'
                                if not (sshd_text | regex_search("PermitEmptyPasswords no"))
                                else 'No action needed')
              },
              "ensure_sshd_rootlogin_disabled": {
                "status": ('yes' if sshd_text | regex_search("PermitRootLogin no") else 'no'),
                "remediation": ('Add PermitRootLogin no'
                                if not (sshd_text | regex_search("PermitRootLogin no"))
                                else 'No action needed')
              },
              "ensure_sshd_userenv_disabled": {
                "status": ('yes' if sshd_text | regex_search("PermitUserEnvironment no") else 'no'),
                "remediation": ('Add PermitUserEnvironment no'
                                if not (sshd_text | regex_search("PermitUserEnvironment no"))
                                else 'No action needed')
              },
              "ensure_sshd_usepam": {
                "status": ('yes' if sshd_text | regex_search("UsePAM yes") else 'no'),
                "remediation": ('Add UsePAM yes'
                                if not (sshd_text | regex_search("UsePAM yes"))
                                else 'No action needed')
              }
            })
          }}

    # ------------------------------------------------------------------
    # SAVE REPORT
    # ------------------------------------------------------------------

    - name: Save JSON report on collector
      copy:
        dest: "{{ export_dir }}/ssh_access_report_{{ inventory_hostname }}.json"
        content: "{{ ssh_report | to_nice_json }}"
        mode: '0644'
      delegate_to: "{{ collector_host }}"

# MERGE ------------------------------------------------------------------

- name: Merge all SSH JSON reports
  hosts: 192.168.2.129
  become: yes
  gather_facts: no
  

  vars:
    export_dir: "/home/ansibleadmin/Documents/linux_hardening"
    merged_file: "access_control.json"
    become_user: root
    

  tasks:
    - name: Merge reports
      shell: "cat {{ export_dir }}/ssh_access_report_*.json | jq -s '.' > {{ export_dir }}/{{ merged_file }}"
      args:
        executable: /bin/bash

    - name: Confirm merged file path
      debug:
        msg: "SSH compliance report merged â†’ {{ export_dir }}/{{ merged_file }}"
