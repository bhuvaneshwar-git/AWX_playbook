---
- name: Gather system information
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    # Add timestamp for unique filenames (e.g. 2025-10-27T12-45-32)
    export_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%dT%H-%M-%S') }}"

  tasks:
    - name: Collect system information facts
      set_fact:
        sysinfo:
          hostname: "{{ ansible_hostname }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          kernel: "{{ ansible_kernel }}"
          architecture: "{{ ansible_architecture }}"
          cpu: "{{ ansible_processor[1] | regex_replace('.*Intel.*', 'Intel') | regex_replace('.*AMD.*', 'AMD') }}"
          ram_gb: "{{ (ansible_memtotal_mb / 1024) | round(0) }}"
          storage_gb: "{{ (ansible_mounts[0].size_total / 1024 / 1024 / 1024) | round(0) }}"
          current_user: "{{ lookup('env', 'USER') }}"

    - name: Show system info in human-readable format
      debug:
        msg: |
          ===== System Information =====
          Hostname: {{ sysinfo.hostname }}
          OS: {{ sysinfo.os }}
          Kernel: {{ sysinfo.kernel }}
          Architecture: {{ sysinfo.architecture }}
          CPU: {{ sysinfo.cpu }}
          RAM: {{ sysinfo.ram_gb }} GB
          Storage: {{ sysinfo.storage_gb }} GB
          Current User: {{ sysinfo.current_user }}
          =================================

    # ✅ Create artifacts directory safely (inside the controller pod)
    - name: Ensure artifacts directory exists
      delegate_to: localhost
      run_once: true
      become: false
      ansible.builtin.file:
        path: "{{ playbook_dir }}/artifacts"
        state: directory
        mode: '0755'

    # ✅ Save JSON output in the controller pod (AWX)
    - name: Save JSON file to artifacts directory (inside AWX)
      delegate_to: localhost
      become: false
      ansible.builtin.copy:
        content: "{{ sysinfo | to_nice_json }}"
        dest: "{{ playbook_dir }}/artifacts/system_info_{{ inventory_hostname }}_{{ export_timestamp }}.json"
        mode: '0644'

    # ✅ Ensure persistent export directory exists on host
    - name: Ensure /home/ansibleadmin/awx_exports exists
      delegate_to: localhost
      become: false
      become_user: root
      ansible.builtin.file:
        path: "/home/ansibleadmin/awx_exports"
        state: directory
        mode: '0777'

    # ✅ Copy JSON file to host machine (persistent storage)
    - name: Copy JSON file to host machine (persistent storage)
      delegate_to: localhost
      become: false
      become_user: root
      ansible.builtin.copy:
        content: "{{ sysinfo | to_nice_json }}"
        dest: "/home/bhuvaneshwar.g/awx_exports/system_info_{{ inventory_hostname }}_{{ export_timestamp }}.json"
        mode: '0644'

    - name: Notify completion
      debug:
        msg: |
          ✅ System info JSON exported to:
             - {{ playbook_dir }}/artifacts/
             - /home/ansibleadmin/awx_exports/
          (Each file includes a timestamp for versioning)
