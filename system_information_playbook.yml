---
- name: Gather system information and save in one file
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    collector_host: "192.168.2.111"   # <-- change this IP to the system where final file should be stored
    export_dir: "/tmp/sysinfo_exports"

  tasks:
    - name: Ensure export directory exists on each host
      file:
        path: "{{ export_dir }}"
        state: directory
        mode: "0755"

    - name: Gather system information
      set_fact:
        sysinfo:
          hostname: "{{ ansible_hostname }}"
          ip_address: "{{ ansible_host }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          kernel: "{{ ansible_kernel }}"
          architecture: "{{ ansible_architecture }}"
          cpu: "{{ ansible_processor[0] }}"
          ram_gb: "{{ (ansible_memtotal_mb / 1024) | round(1) }}"
          storage_gb: "{{ (ansible_devices['sda'].size | regex_replace(' GB', '') | float) | default(0) }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: Write system info to a JSON file on each host
      copy:
        content: "{{ sysinfo | to_nice_json }}"
        dest: "{{ export_dir }}/system_info_{{ ansible_host }}.json"

    # âœ… Copy all JSON files from each host to the collector
    - name: Copy JSON files from all hosts to collector
      fetch:
        src: "{{ export_dir }}/system_info_{{ ansible_host }}.json"
        dest: "/tmp/collected_files/"
        flat: yes
      delegate_to: "{{ collector_host }}"

- name: Combine all system info into one JSON file on collector
  hosts: "{{ collector_host }}"
  gather_facts: no
  become: yes

  vars:
    export_dir: "/tmp/collected_files"
    output_file: "/tmp/all_system_info.json"

  tasks:
    - name: Ensure jq is installed
      apt:
        name: jq
        state: present
      become: yes

    - name: Combine all JSON files into one
      shell: "jq -s '.' {{ export_dir }}/*.json > {{ output_file }}"
      args:
        executable: /bin/bash

    - name: Display combined file path
      debug:
        msg: "All system information saved to {{ output_file }} on {{ inventory_hostname }}"
